#!/bin/bash

# LinGear CLI Tool
# A developer-friendly interface for the LinGear Kiosk Framework

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Paths
LINGEAR_ROOT="$(dirname "$(realpath "$0")")"
INSTALLER_SCRIPT="$LINGEAR_ROOT/installer/scripts/install.sh"

# Helper: Check if whiptail is installed
check_whiptail() {
    if ! command -v whiptail &> /dev/null; then
        echo -e "${YELLOW}Whiptail is not installed. Installing it now...${NC}"
        sudo apt-get update && sudo apt-get install -y whiptail
    fi
}

# Command: Init
cmd_init() {
    local project_name
    project_name=$(whiptail --inputbox "Enter your project name:" 8 78 "MyKioskApp" --title "New Project" 3>&1 1>&2 2>&3)
    exitstatus=$?
    if [ $exitstatus = 0 ]; then
        local framework
        framework=$(whiptail --menu "Select Framework:" 15 60 2 \
        "qt" "Qt 6 (C++)" \
        "lvgl" "LVGL (C++)" 3>&1 1>&2 2>&3)
        
        if [ $? = 0 ]; then
            echo -e "${GREEN}Creating project '$project_name' using $framework...${NC}"
            
            mkdir -p "$project_name/src"
            
            if [ "$framework" == "qt" ]; then
                mkdir -p "$project_name/src/qt-app"
                # Create CMakeLists.txt
                cat > "$project_name/src/qt-app/CMakeLists.txt" << EOF
cmake_minimum_required(VERSION 3.16)
project($project_name LANGUAGES CXX)
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
find_package(Qt6 REQUIRED COMPONENTS Widgets)
add_executable($project_name main.cpp)
target_link_libraries($project_name PRIVATE Qt6::Widgets)
install(TARGETS $project_name DESTINATION bin)
EOF
                # Create main.cpp
                cat > "$project_name/src/qt-app/main.cpp" << EOF
#include <QApplication>
#include <QLabel>
int main(int argc, char *argv[]) {
    QApplication app(argc, argv);
    QLabel label("Hello $project_name!");
    label.showFullScreen();
    return app.exec();
}
EOF
            elif [ "$framework" == "lvgl" ]; then
                mkdir -p "$project_name/src/lvgl-app"
                echo "LVGL scaffolding not fully implemented yet." > "$project_name/src/lvgl-app/README.txt"
            fi
            
            # Create lingear.json config
            cat > "$project_name/lingear.json" << EOF
{
    "name": "$project_name",
    "framework": "$framework",
    "user": "kiosk"
}
EOF
            echo -e "${GREEN}Project created in ./$project_name${NC}"
        fi
    fi
}

# Command: Install
cmd_install() {
    echo -e "${GREEN}Starting System Installation...${NC}"
    # For now, we call the existing installer. 
    # In the future, we can pass arguments to make it non-interactive.
    sudo bash "$INSTALLER_SCRIPT"
}

# Command: Build
cmd_build() {
    if [ ! -f "lingear.json" ]; then
        echo -e "${RED}Error: Not a LinGear project directory (missing lingear.json)${NC}"
        return 1
    fi
    
    # Read config (simple grep for now, ideally use jq if available)
    local framework=$(grep '"framework"' lingear.json | cut -d '"' -f 4)
    local name=$(grep '"name"' lingear.json | cut -d '"' -f 4)
    
    echo -e "${GREEN}Building $name ($framework)...${NC}"
    
    if [ "$framework" == "qt" ]; then
        mkdir -p build
        cd build
        cmake ../src/qt-app
        make -j$(nproc)
        cd ..
        echo -e "${GREEN}Build complete!${NC}"
    else
        echo -e "${YELLOW}Build logic for $framework not implemented in CLI yet.${NC}"
    fi
}

# Command: Deploy
cmd_deploy() {
    if [ ! -f "lingear.json" ]; then
        echo -e "${RED}Error: Not a LinGear project directory (missing lingear.json)${NC}"
        return 1
    fi
    
    local name=$(grep '"name"' lingear.json | cut -d '"' -f 4)
    local target_dir="/opt/kiosk/$name"
    
    echo -e "${GREEN}Deploying to $target_dir...${NC}"
    
    sudo mkdir -p "$target_dir"
    
    # Assuming build artifact name matches project name for now
    if [ -f "build/$name" ]; then
        sudo cp "build/$name" "$target_dir/qt-app" # Renaming to standard expected by launcher for now
        sudo chown -R kiosk:kiosk "$target_dir"
        sudo chmod +x "$target_dir/qt-app"
        echo -e "${GREEN}Deployed successfully.${NC}"
        echo -e "${GREEN}Restarting kiosk service...${NC}"
        sudo systemctl restart kiosk
    else
        echo -e "${RED}Build artifact not found. Run 'lingear build' first.${NC}"
    fi
}

# Command: Doctor
cmd_doctor() {
    echo -e "${GREEN}Running LinGear Doctor...${NC}"
    echo "--------------------------------"
    
    # Check OS
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        echo -e "OS: ${GREEN}$PRETTY_NAME${NC}"
    else
        echo -e "OS: ${RED}Unknown${NC}"
    fi
    
    # Check Dependencies
    local deps=("cmake" "g++" "git" "whiptail")
    for dep in "${deps[@]}"; do
        if command -v $dep &> /dev/null; then
            echo -e "$dep: ${GREEN}Installed${NC}"
        else
            echo -e "$dep: ${RED}Missing${NC}"
        fi
    done
    
    # Check Kiosk Service
    if systemctl is-active --quiet kiosk; then
        echo -e "Kiosk Service: ${GREEN}Running${NC}"
    else
        echo -e "Kiosk Service: ${YELLOW}Not Running${NC}"
    fi
    
    echo "--------------------------------"
    echo -e "${GREEN}Diagnosis Complete.${NC}"
}

# Main Menu
show_main_menu() {
    check_whiptail
    
    local choice
    choice=$(whiptail --title "LinGear CLI" --menu "Choose an option:" 20 78 10 \
    "init" "Initialize a new project" \
    "install" "Install system dependencies & setup" \
    "build" "Build the current project" \
    "deploy" "Deploy to kiosk" \
    "doctor" "Diagnose issues" \
    "help" "Show help" 3>&1 1>&2 2>&3)
    
    exitstatus=$?
    if [ $exitstatus = 0 ]; then
        case $choice in
            init) cmd_init ;;
            install) cmd_install ;;
            build) cmd_build ;;
            deploy) cmd_deploy ;;
            doctor) cmd_doctor ;;
            help) echo "Usage: lingear [command]"; echo "Commands: init, install, build, deploy, doctor";;
        esac
    else
        echo "Cancelled."
    fi
}

# Entry Point
if [ -z "$1" ]; then
    show_main_menu
else
    case $1 in
        init) cmd_init ;;
        install) cmd_install ;;
        build) cmd_build ;;
        deploy) cmd_deploy ;;
        doctor) cmd_doctor ;;
        help|--help|-h) echo "Usage: lingear [command]"; echo "Commands: init, install, build, deploy, doctor";;
        *) echo "Unknown command: $1"; echo "Try 'lingear help'"; exit 1 ;;
    esac
fi
